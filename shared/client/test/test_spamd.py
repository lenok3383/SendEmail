"""Unit tests for spamd_client package.

$Id: //prod/main/_is/shared/python/client/test/test_spamd.py#1 $
$Author: ddrawhor $
"""

import _socket
import logging
import re
import socket
import string
import StringIO
import unittest2

from cBencode import bencode

from shared.client.spamd import *
from shared.testing.vmock import matchers
from shared.testing.vmock.mockcontrol import MockControl

TEST_APP_NAME = 'client_spamd_test'

PROTOCOL_VERSION = '1.4'

# Setup logging.
LOG_LEVEL = logging.CRITICAL
logging.basicConfig(level=LOG_LEVEL)

gtube = \
"""Received: from webmail.ironportsystems.com ([10.1.1.155]) by anakin.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
Received: from trino ([10.1.1.209]) by webmail.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
From: "Taras Todosiychuk" <taras@ironport.com>
To: <konstantin@ironport.com>
Subject: test
Date: Tue, 3 Jan 2006 16:57:15 +0200
MIME-Version: 1.0
Content-Type: text/plain;
    charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Mailer: Microsoft Office Outlook, Build 11.0.6353
Thread-Index: AcYQdfvaWdu6CJENR6aAPKal5UIHHg==
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1506
Return-Path: taras@ironport.com
Message-ID: <WEBMAILix4A2DreBBsQ00000022@webmail.ironportsystems.com>
X-OriginalArrivalTime: 03 Jan 2006 14:57:41.0796 (UTC) FILETIME=[0BDE9640:01C61076]


http://rambler.ru
test

XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X"""

gtube_check_resp = \
"""SPAMD/1.1 0 EX_OK\r
Spam: True ; 998.6 / 5.0\r
X-IronPort-MGA: d3:MGAd18:IPAS_RESULT_STRING64:Av//AAbflk4AAAAA/2dsb2JhbAAMgmqFQoEsoTgyTAUqPhoJFQQDAQQewE6gGYwQ16:IPA""" \
"""S_RULES_COUNTd11:ALL_TRUSTEDi1e5:GTUBEi1e21:IP_DQ_MSGID_0000_HEX4i1e23:IP_DQ_MSOE_CLONE_RCVD_3i1e17:ZBL_ANY_MICROS""" \
"""OFTi1e15:ZBL_CT_US_ASCIIi1e25:ZBL_HAS_OUTLOOK_IN_MAILERi1e20:ZBL_HAS_THREAD_INDEXi1e18:ZBL_IMG_TXTR_13_14i1e18:ZBL_OU""" \
"""TLOOK_EUDORAi1e22:ZBL_PRODUCED_BY_MS_OLEi1e27:ZBL_RELAY_FIRST_FROM_AZ_3_7i1e23:ZBL_SUBJECT_LOWER_WORDSi1e26:ZBL_SUBJ_""" \
"""SHORT_RANDOM_WORDi1e21:ZBL_THREAD_INDEX_GOODi1e22:ZBL_THREAD_INDEX_SHORTi1e19:ZBL_TO_HAS_ANGLE_BRi1e19:ZBL_XMAILER_OU""" \
"""TLOOKi1e20:__AK_RCVD_LACKS_HELOi1e20:__AK_RCVD_LACKS_RDNSi1e15:__ANY_MICROSOFTi1e18:__CM_MSGID_REPEATSi1e19:__CM_NO_Y""" \
"""AHOO_CO_JPi1e30:__CM_OUTLOOK_11_0_6353_XMAILERi1e4:__CTi1e5:__CTEi1e10:__CTE_7BITi1e15:__CT_TEXT_PLAINi1e13:__CT_US_A""" \
"""SCIIi1e20:__E2_KB_SOME_SUBJECTi1e32:__ES_BODY_HTTP_COLON_SLASH_SLASHi1e24:__FPR_BODY_348060_690936i1e26:__FPR_HEADER_""" \
"""228918_555162i1e26:__FPR_HEADER_250910_592020i1e26:__FPR_HEADER_258026_607859i1e26:__FPR_HEADER_261091_615742i1e26:__""" \
"""FPR_HEADER_262542_618996i1e26:__FPR_HEADER_267187_630373i1e26:__FPR_HEADER_267406_630949i1e26:__FPR_HEADER_267406_630""" \
"""952i1e26:__FPR_HEADER_271199_640554i1e26:__FPR_HEADER_272471_643634i1e26:__FPR_HEADER_287303_661141i1e26:__FPR_HEADER""" \
"""_294759_664991i1e26:__FPR_HEADER_294759_664993i1e26:__FPR_HEADER_298948_667093i1e26:__FPR_HEADER_322729_679758i1e26:_""" \
"""_FPR_HEADER_331091_683269i1e26:__FPR_HEADER_332514_683882i1e26:__FPR_HEADER_332727_683961i1e26:__FPR_HEADER_340385_68""" \
"""7339i1e26:__FPR_HEADER_342974_688453i1e26:__FPR_HEADER_345997_689891i1e26:__FPR_HEADER_348259_691037i1e26:__FPR_HEADE""" \
"""R_348691_691261i1e26:__FPR_HEADER_348691_691264i1e26:__FPR_HEADER_352725_693662i1e26:__FPR_HEADER_353482_694137i1e26:""" \
"""__FPR_HEADER_355550_695416i1e26:__FPR_HEADER_356464_696001i1e26:__FPR_HEADER_357218_696552i1e26:__FPR_HEADER_360190_6""" \
"""98240i1e26:__FPR_HEADER_360404_698393i1e26:__FPR_HEADER_363112_699945i1e26:__FPR_HEADER_363112_699950i1e26:__FPR_HEAD""" \
"""ER_363466_700153i1e26:__FPR_HEADER_367777_702514i1e26:__FPR_HEADER_369344_703336i1e26:__FPR_HEADER_371214_704149i1e26""" \
""":__FPR_HEADER_371214_704150i1e26:__FPR_HEADER_371214_704151i1e26:__FPR_HEADER_371214_704153i1e26:__FPR_HEADER_373200_""" \
"""705158i1e26:__FPR_HEADER_374137_705598i1e26:__FPR_HEADER_374446_705764i1e19:__FROM_HAS_ANGLE_BRi1e20:__FROM_NAME_NO_L""" \
"""OCALi1e13:__FROM_REPEATi1e19:__FROM_REPEAT_OKAY4i1e16:__GLM_BODY_EMAILi1e16:__HAS_CT_CHARSETi1e10:__HAS_DATEi1e16:__H""" \
"""AS_MESSAGE_IDi1e13:__HAS_MIMEOLEi1e11:__HAS_MSGIDi1e23:__HAS_OUTLOOK_IN_MAILERi1e10:__HAS_RCVDi1e13:__HAS_SUBJECTi1e1""" \
"""8:__HAS_THREAD_INDEXi1e8:__HAS_TOi1e13:__HAS_TRUSTEDi1e14:__HAS_X_MAILERi1e27:__HAS_X_ORIGINALARRIVALTIMEi1e14:__HELO""" \
"""_RCVD_AZi1e22:__HW_H_TO_NO_REAL_NAMEi1e16:__IMG_TXTR_13_14i1e18:__IP_DF_MISC_OB_TOi1e20:__IP_KB_GOOD_HEADERSi1e23:__I""" \
"""RONPORTSYSTEMS_MSGIDi1e14:__MID_INTL_TLDi1e14:__MIME_VERSIONi1e15:__MISSING_REPLYi1e14:__MSFT_SMTPSVCi1e15:__MSGID_OK""" \
"""_HOSTi1e18:__NONEMPTY_RAWBODYi1e24:__NOT_MSGID_LEGIT_OL_WUBi1e16:__OUTLOOK_EUDORAi1e20:__PRODUCED_BY_MS_OLEi1e14:__RC""" \
"""VD_WEBMAILi1e25:__RELAY_FIRST_FROM_AZ_3_7i1e13:__RL_CTE_7BITi1e12:__SANE_MSGIDi1e38:__SPAMMY_XMAILERS_FOR_RCVD_FROM_I""" \
"""PADDRi1e12:__START_HTTPi1e21:__SUBJECT_LOWER_WORDSi1e21:__SUBJECT_NONE_OR_ONEi1e24:__SUBJ_SHORT_RANDOM_WORDi1e19:__TH""" \
"""READ_INDEX_GOODi1e20:__THREAD_INDEX_SHORTi1e13:__TOCC_EXISTSi1e30:__TO_ADDRESS_BRACKETED_NO_NAMEi1e17:__TO_HAS_ANGLE_""" \
"""BRi1e17:__TO_NO_REAL_NAMEi1e10:__URI_HTTPi1e26:__URI_NAME_TOPLEVEL_NON_USi1e17:__VERY_SANE_MSGIDi1e21:__VOF_TO_ADDRES""" \
"""S_ONLYi1e17:__XMAILER_OUTLOOKi1e13:__ZQ_URI_HTTPi1e12:___HAS_MSGIDi1e31:___PL_RCVD_MSNORLIVEORMICROSOFTi1e10:___TZ_02""" \
"""00i1ee10:IPAS_SCOREi100e10:URL_EXISTSi1e13:VOF_FILENAMESle9:VOF_SCOREi0ee4:SBNPd10:CONNECTIONd7:0.0.0.0d18:IPAS_MESSA""" \
"""GE_COUNTi1eee2:IPd7:0.0.0.0d18:IPAS_MESSAGE_COUNTi1e16:IPAS_SCORE_LOCALi100e18:SBNP_MESSAGE_COUNTi1e17:VOF_MESSAGE_CO""" \
"""UNTi1eee16:IPAS_RULES_COUNTd11:ALL_TRUSTEDi1e5:GTUBEi1e21:IP_DQ_MSGID_0000_HEX4i1e23:IP_DQ_MSOE_CLONE_RCVD_3i1e17:ZBL""" \
"""_ANY_MICROSOFTi1e15:ZBL_CT_US_ASCIIi1e25:ZBL_HAS_OUTLOOK_IN_MAILERi1e20:ZBL_HAS_THREAD_INDEXi1e18:ZBL_IMG_TXTR_13_14i""" \
"""1e18:ZBL_OUTLOOK_EUDORAi1e22:ZBL_PRODUCED_BY_MS_OLEi1e27:ZBL_RELAY_FIRST_FROM_AZ_3_7i1e23:ZBL_SUBJECT_LOWER_WORDSi1e2""" \
"""6:ZBL_SUBJ_SHORT_RANDOM_WORDi1e21:ZBL_THREAD_INDEX_GOODi1e22:ZBL_THREAD_INDEX_SHORTi1e19:ZBL_TO_HAS_ANGLE_BRi1e19:ZBL""" \
"""_XMAILER_OUTLOOKi1e20:__AK_RCVD_LACKS_HELOi1e20:__AK_RCVD_LACKS_RDNSi1e15:__ANY_MICROSOFTi1e18:__CM_MSGID_REPEATSi1e1""" \
"""9:__CM_NO_YAHOO_CO_JPi1e30:__CM_OUTLOOK_11_0_6353_XMAILERi1e4:__CTi1e5:__CTEi1e10:__CTE_7BITi1e15:__CT_TEXT_PLAINi1e1""" \
"""3:__CT_US_ASCIIi1e20:__E2_KB_SOME_SUBJECTi1e32:__ES_BODY_HTTP_COLON_SLASH_SLASHi1e24:__FPR_BODY_348060_690936i1e26:__""" \
"""FPR_HEADER_228918_555162i1e26:__FPR_HEADER_250910_592020i1e26:__FPR_HEADER_258026_607859i1e26:__FPR_HEADER_261091_615""" \
"""742i1e26:__FPR_HEADER_262542_618996i1e26:__FPR_HEADER_267187_630373i1e26:__FPR_HEADER_267406_630949i1e26:__FPR_HEADER""" \
"""_267406_630952i1e26:__FPR_HEADER_271199_640554i1e26:__FPR_HEADER_272471_643634i1e26:__FPR_HEADER_287303_661141i1e26:_""" \
"""_FPR_HEADER_294759_664991i1e26:__FPR_HEADER_294759_664993i1e26:__FPR_HEADER_298948_667093i1e26:__FPR_HEADER_322729_67""" \
"""9758i1e26:__FPR_HEADER_331091_683269i1e26:__FPR_HEADER_332514_683882i1e26:__FPR_HEADER_332727_683961i1e26:__FPR_HEADE""" \
"""R_340385_687339i1e26:__FPR_HEADER_342974_688453i1e26:__FPR_HEADER_345997_689891i1e26:__FPR_HEADER_348259_691037i1e26:""" \
"""__FPR_HEADER_348691_691261i1e26:__FPR_HEADER_348691_691264i1e26:__FPR_HEADER_352725_693662i1e26:__FPR_HEADER_353482_6""" \
"""94137i1e26:__FPR_HEADER_355550_695416i1e26:__FPR_HEADER_356464_696001i1e26:__FPR_HEADER_357218_696552i1e26:__FPR_HEAD""" \
"""ER_360190_698240i1e26:__FPR_HEADER_360404_698393i1e26:__FPR_HEADER_363112_699945i1e26:__FPR_HEADER_363112_699950i1e26""" \
""":__FPR_HEADER_363466_700153i1e26:__FPR_HEADER_367777_702514i1e26:__FPR_HEADER_369344_703336i1e26:__FPR_HEADER_371214_""" \
"""704149i1e26:__FPR_HEADER_371214_704150i1e26:__FPR_HEADER_371214_704151i1e26:__FPR_HEADER_371214_704153i1e26:__FPR_HEA""" \
"""DER_373200_705158i1e26:__FPR_HEADER_374137_705598i1e26:__FPR_HEADER_374446_705764i1e19:__FROM_HAS_ANGLE_BRi1e20:__FRO""" \
"""M_NAME_NO_LOCALi1e13:__FROM_REPEATi1e19:__FROM_REPEAT_OKAY4i1e16:__GLM_BODY_EMAILi1e16:__HAS_CT_CHARSETi1e10:__HAS_DA""" \
"""TEi1e16:__HAS_MESSAGE_IDi1e13:__HAS_MIMEOLEi1e11:__HAS_MSGIDi1e23:__HAS_OUTLOOK_IN_MAILERi1e10:__HAS_RCVDi1e13:__HAS_""" \
"""SUBJECTi1e18:__HAS_THREAD_INDEXi1e8:__HAS_TOi1e13:__HAS_TRUSTEDi1e14:__HAS_X_MAILERi1e27:__HAS_X_ORIGINALARRIVALTIMEi""" \
"""1e14:__HELO_RCVD_AZi1e22:__HW_H_TO_NO_REAL_NAMEi1e16:__IMG_TXTR_13_14i1e18:__IP_DF_MISC_OB_TOi1e20:__IP_KB_GOOD_HEADE""" \
"""RSi1e23:__IRONPORTSYSTEMS_MSGIDi1e14:__MID_INTL_TLDi1e14:__MIME_VERSIONi1e15:__MISSING_REPLYi1e14:__MSFT_SMTPSVCi1e15""" \
""":__MSGID_OK_HOSTi1e18:__NONEMPTY_RAWBODYi1e24:__NOT_MSGID_LEGIT_OL_WUBi1e16:__OUTLOOK_EUDORAi1e20:__PRODUCED_BY_MS_OL""" \
"""Ei1e14:__RCVD_WEBMAILi1e25:__RELAY_FIRST_FROM_AZ_3_7i1e13:__RL_CTE_7BITi1e12:__SANE_MSGIDi1e38:__SPAMMY_XMAILERS_FOR_""" \
"""RCVD_FROM_IPADDRi1e12:__START_HTTPi1e21:__SUBJECT_LOWER_WORDSi1e21:__SUBJECT_NONE_OR_ONEi1e24:__SUBJ_SHORT_RANDOM_WOR""" \
"""Di1e19:__THREAD_INDEX_GOODi1e20:__THREAD_INDEX_SHORTi1e13:__TOCC_EXISTSi1e30:__TO_ADDRESS_BRACKETED_NO_NAMEi1e17:__TO""" \
"""_HAS_ANGLE_BRi1e17:__TO_NO_REAL_NAMEi1e10:__URI_HTTPi1e26:__URI_NAME_TOPLEVEL_NON_USi1e17:__VERY_SANE_MSGIDi1e21:__VO""" \
"""F_TO_ADDRESS_ONLYi1e17:__XMAILER_OUTLOOKi1e13:__ZQ_URI_HTTPi1e12:___HAS_MSGIDi1e31:___PL_RCVD_MSNORLIVEORMICROSOFTi1e""" \
"""10:___TZ_0200i1ee24:IPAS_RULES_MESSAGE_COUNTi1e24:IPAS_SPAM_POSITIVE_LIMITi90e23:IPAS_SPAM_SUSPECT_LIMITi50e14:REGION""" \
"""_PROFILE6:global13:SERIAL_NUMBERd10:2011090800i1ee22:UNKNOWN_INCOMING_RELAYi1ee7:SBNP_AVd2:IPd7:0.0.0.0deeee\r
X-IronPort-IPAS-Score: 100\r
\r
\r"""

gtube_check_result = \
"""response: 0 : EX_OK
spamd version: 1.1
is_spam: True
score: 998.6
threshold: 5.0
ipas_score: 100
case: {'SBNP': {'IP': {'0.0.0.0': {'IPAS_SCORE_LOCAL': 100, 'IPAS_MESSAGE_COUNT': 1, 'VOF_MESSAGE_COUNT': 1, 'SBNP_MESSA""" \
"""GE_COUNT': 1}}, 'IPAS_SPAM_SUSPECT_LIMIT': 50, 'IPAS_RULES_COUNT': {'__FPR_HEADER_363112_699950': 1, 'ZBL_RELAY_FIRST""" \
"""_FROM_AZ_3_7': 1, '__HAS_TO': 1, '__URI_HTTP': 1, '__FPR_HEADER_371214_704151': 1, '__CTE': 1, '__FPR_HEADER_371214_7""" \
"""04153': 1, '__SPAMMY_XMAILERS_FOR_RCVD_FROM_IPADDR': 1, '__FROM_NAME_NO_LOCAL': 1, '__FPR_HEADER_258026_607859': 1, '""" \
"""__GLM_BODY_EMAIL': 1, '__FPR_HEADER_298948_667093': 1, 'ALL_TRUSTED': 1, 'ZBL_CT_US_ASCII': 1, '__NOT_MSGID_LEGIT_OL_""" \
"""WUB': 1, '__FPR_HEADER_363112_699945': 1, 'IP_DQ_MSOE_CLONE_RCVD_3': 1, '__FPR_HEADER_267406_630952': 1, '__FPR_HEADE""" \
"""R_348691_691264': 1, '__HAS_THREAD_INDEX': 1, '__FPR_HEADER_348691_691261': 1, '__NONEMPTY_RAWBODY': 1, '__FPR_HEADER""" \
"""_261091_615742': 1, '__CTE_7BIT': 1, '__CM_NO_YAHOO_CO_JP': 1, '__IP_KB_GOOD_HEADERS': 1, '__FPR_HEADER_371214_704150""" \
"""': 1, 'ZBL_ANY_MICROSOFT': 1, 'ZBL_IMG_TXTR_13_14': 1, '__HAS_OUTLOOK_IN_MAILER': 1, 'ZBL_SUBJECT_LOWER_WORDS': 1, '_""" \
"""_TO_NO_REAL_NAME': 1, '__FPR_HEADER_267406_630949': 1, '__FPR_HEADER_363466_700153': 1, '__FPR_HEADER_294759_664993':""" \
""" 1, '__FPR_HEADER_294759_664991': 1, '__SUBJECT_LOWER_WORDS': 1, '__FPR_HEADER_340385_687339': 1, '__FPR_HEADER_35555""" \
"""0_695416': 1, '__FPR_HEADER_267187_630373': 1, '__RELAY_FIRST_FROM_AZ_3_7': 1, '__FROM_REPEAT': 1, '__AK_RCVD_LACKS_H""" \
"""ELO': 1, '__VOF_TO_ADDRESS_ONLY': 1, '__MSFT_SMTPSVC': 1, '___TZ_0200': 1, '__FPR_HEADER_348259_691037': 1, '__FPR_HE""" \
"""ADER_332514_683882': 1, '___HAS_MSGID': 1, '__MIME_VERSION': 1, '__AK_RCVD_LACKS_RDNS': 1, '__FPR_HEADER_250910_59202""" \
"""0': 1, '__CT_TEXT_PLAIN': 1, '__FPR_HEADER_357218_696552': 1, '__VERY_SANE_MSGID': 1, '__FPR_HEADER_353482_694137': 1""" \
""", '__FPR_HEADER_228918_555162': 1, 'ZBL_THREAD_INDEX_GOOD': 1, '__HAS_X_ORIGINALARRIVALTIME': 1, '__E2_KB_SOME_SUBJEC""" \
"""T': 1, '__HAS_X_MAILER': 1, '__START_HTTP': 1, 'ZBL_SUBJ_SHORT_RANDOM_WORD': 1, '__HAS_MESSAGE_ID': 1, '__URI_NAME_TO""" \
"""PLEVEL_NON_US': 1, 'GTUBE': 1, '__FPR_HEADER_262542_618996': 1, '__FPR_HEADER_369344_703336': 1, 'IP_DQ_MSGID_0000_HE""" \
"""X4': 1, '__HAS_TRUSTED': 1, '__FPR_HEADER_360404_698393': 1, '__HAS_SUBJECT': 1, 'ZBL_OUTLOOK_EUDORA': 1, 'ZBL_XMAILE""" \
"""R_OUTLOOK': 1, '__IMG_TXTR_13_14': 1, '__SANE_MSGID': 1, '___PL_RCVD_MSNORLIVEORMICROSOFT': 1, '__SUBJECT_NONE_OR_ONE""" \
"""': 1, '__FROM_HAS_ANGLE_BR': 1, '__CM_OUTLOOK_11_0_6353_XMAILER': 1, '__SUBJ_SHORT_RANDOM_WORD': 1, '__TO_HAS_ANGLE_B""" \
"""R': 1, '__TOCC_EXISTS': 1, '__FPR_HEADER_352725_693662': 1, '__HAS_CT_CHARSET': 1, '__FROM_REPEAT_OKAY4': 1, '__RL_CT""" \
"""E_7BIT': 1, '__MSGID_OK_HOST': 1, '__FPR_HEADER_272471_643634': 1, '__THREAD_INDEX_GOOD': 1, '__MID_INTL_TLD': 1, '__""" \
"""HAS_MIMEOLE': 1, '__FPR_HEADER_356464_696001': 1, '__FPR_HEADER_322729_679758': 1, '__FPR_HEADER_287303_661141': 1, '""" \
"""__FPR_HEADER_345997_689891': 1, '__FPR_HEADER_367777_702514': 1, '__IRONPORTSYSTEMS_MSGID': 1, '__FPR_HEADER_360190_6""" \
"""98240': 1, '__OUTLOOK_EUDORA': 1, 'ZBL_HAS_THREAD_INDEX': 1, '__ZQ_URI_HTTP': 1, '__FPR_HEADER_331091_683269': 1, '__""" \
"""FPR_HEADER_271199_640554': 1, '__HW_H_TO_NO_REAL_NAME': 1, '__RCVD_WEBMAIL': 1, '__FPR_HEADER_374137_705598': 1, '__H""" \
"""AS_MSGID': 1, '__HELO_RCVD_AZ': 1, '__XMAILER_OUTLOOK': 1, '__IP_DF_MISC_OB_TO': 1, '__FPR_HEADER_332727_683961': 1, """ \
"""'__CT_US_ASCII': 1, '__FPR_HEADER_342974_688453': 1, 'ZBL_HAS_OUTLOOK_IN_MAILER': 1, '__THREAD_INDEX_SHORT': 1, '__HA""" \
"""S_RCVD': 1, '__ANY_MICROSOFT': 1, '__FPR_HEADER_371214_704149': 1, '__CT': 1, '__ES_BODY_HTTP_COLON_SLASH_SLASH': 1, """ \
"""'__PRODUCED_BY_MS_OLE': 1, 'ZBL_PRODUCED_BY_MS_OLE': 1, 'ZBL_THREAD_INDEX_SHORT': 1, 'ZBL_TO_HAS_ANGLE_BR': 1, '__MIS""" \
"""SING_REPLY': 1, '__HAS_DATE': 1, '__CM_MSGID_REPEATS': 1, '__FPR_HEADER_373200_705158': 1, '__TO_ADDRESS_BRACKETED_NO""" \
"""_NAME': 1, '__FPR_HEADER_374446_705764': 1, '__FPR_BODY_348060_690936': 1}, 'CONNECTION': {'0.0.0.0': {'IPAS_MESSAGE_""" \
"""COUNT': 1}}, 'IPAS_SPAM_POSITIVE_LIMIT': 90, 'REGION_PROFILE': 'global', 'SERIAL_NUMBER': {'2011090800': 1}, 'UNKNOWN""" \
"""_INCOMING_RELAY': 1, 'IPAS_RULES_MESSAGE_COUNT': 1}, 'MGA': {'IPAS_RESULT_STRING': 'Av//AAbflk4AAAAA/2dsb2JhbAAMgmqFQ""" \
"""oEsoTgyTAUqPhoJFQQDAQQewE6gGYwQ', 'IPAS_RULES_COUNT': {'__FPR_HEADER_363112_699950': 1, 'ZBL_RELAY_FIRST_FROM_AZ_3_7'""" \
""": 1, '__HAS_TO': 1, '__URI_HTTP': 1, '__FPR_HEADER_371214_704151': 1, '__CTE': 1, '__FPR_HEADER_371214_704153': 1, '_""" \
"""_SPAMMY_XMAILERS_FOR_RCVD_FROM_IPADDR': 1, '__FROM_NAME_NO_LOCAL': 1, '__FPR_HEADER_258026_607859': 1, '__GLM_BODY_EM""" \
"""AIL': 1, '__FPR_HEADER_298948_667093': 1, 'ALL_TRUSTED': 1, 'ZBL_CT_US_ASCII': 1, '__NOT_MSGID_LEGIT_OL_WUB': 1, '__F""" \
"""PR_HEADER_363112_699945': 1, 'IP_DQ_MSOE_CLONE_RCVD_3': 1, '__FPR_HEADER_267406_630952': 1, '__FPR_HEADER_348691_6912""" \
"""64': 1, '__HAS_THREAD_INDEX': 1, '__FPR_HEADER_348691_691261': 1, '__NONEMPTY_RAWBODY': 1, '__FPR_HEADER_261091_61574""" \
"""2': 1, '__CTE_7BIT': 1, '__CM_NO_YAHOO_CO_JP': 1, '__IP_KB_GOOD_HEADERS': 1, '__FPR_HEADER_371214_704150': 1, 'ZBL_AN""" \
"""Y_MICROSOFT': 1, 'ZBL_IMG_TXTR_13_14': 1, '__HAS_OUTLOOK_IN_MAILER': 1, 'ZBL_SUBJECT_LOWER_WORDS': 1, '__TO_NO_REAL_N""" \
"""AME': 1, '__FPR_HEADER_267406_630949': 1, '__FPR_HEADER_363466_700153': 1, '__FPR_HEADER_294759_664993': 1, '__FPR_HE""" \
"""ADER_294759_664991': 1, '__SUBJECT_LOWER_WORDS': 1, '__FPR_HEADER_340385_687339': 1, '__FPR_HEADER_355550_695416': 1,""" \
""" '__FPR_HEADER_267187_630373': 1, '__RELAY_FIRST_FROM_AZ_3_7': 1, '__FROM_REPEAT': 1, '__AK_RCVD_LACKS_HELO': 1, '__V""" \
"""OF_TO_ADDRESS_ONLY': 1, '__MSFT_SMTPSVC': 1, '___TZ_0200': 1, '__FPR_HEADER_348259_691037': 1, '__FPR_HEADER_332514_6""" \
"""83882': 1, '___HAS_MSGID': 1, '__MIME_VERSION': 1, '__AK_RCVD_LACKS_RDNS': 1, '__FPR_HEADER_250910_592020': 1, '__CT_""" \
"""TEXT_PLAIN': 1, '__FPR_HEADER_357218_696552': 1, '__VERY_SANE_MSGID': 1, '__FPR_HEADER_353482_694137': 1, '__FPR_HEAD""" \
"""ER_228918_555162': 1, 'ZBL_THREAD_INDEX_GOOD': 1, '__HAS_X_ORIGINALARRIVALTIME': 1, '__E2_KB_SOME_SUBJECT': 1, '__HAS""" \
"""_X_MAILER': 1, '__START_HTTP': 1, 'ZBL_SUBJ_SHORT_RANDOM_WORD': 1, '__HAS_MESSAGE_ID': 1, '__URI_NAME_TOPLEVEL_NON_US""" \
"""': 1, 'GTUBE': 1, '__FPR_HEADER_262542_618996': 1, '__FPR_HEADER_369344_703336': 1, 'IP_DQ_MSGID_0000_HEX4': 1, '__HA""" \
"""S_TRUSTED': 1, '__FPR_HEADER_360404_698393': 1, '__HAS_SUBJECT': 1, 'ZBL_OUTLOOK_EUDORA': 1, 'ZBL_XMAILER_OUTLOOK': 1""" \
""", '__IMG_TXTR_13_14': 1, '__SANE_MSGID': 1, '___PL_RCVD_MSNORLIVEORMICROSOFT': 1, '__SUBJECT_NONE_OR_ONE': 1, '__FROM""" \
"""_HAS_ANGLE_BR': 1, '__CM_OUTLOOK_11_0_6353_XMAILER': 1, '__SUBJ_SHORT_RANDOM_WORD': 1, '__TO_HAS_ANGLE_BR': 1, '__TOC""" \
"""C_EXISTS': 1, '__FPR_HEADER_352725_693662': 1, '__HAS_CT_CHARSET': 1, '__FROM_REPEAT_OKAY4': 1, '__RL_CTE_7BIT': 1, '""" \
"""__MSGID_OK_HOST': 1, '__FPR_HEADER_272471_643634': 1, '__THREAD_INDEX_GOOD': 1, '__MID_INTL_TLD': 1, '__HAS_MIMEOLE':""" \
""" 1, '__FPR_HEADER_356464_696001': 1, '__FPR_HEADER_322729_679758': 1, '__FPR_HEADER_287303_661141': 1, '__FPR_HEADER_""" \
"""345997_689891': 1, '__FPR_HEADER_367777_702514': 1, '__IRONPORTSYSTEMS_MSGID': 1, '__FPR_HEADER_360190_698240': 1, '_""" \
"""_OUTLOOK_EUDORA': 1, 'ZBL_HAS_THREAD_INDEX': 1, '__ZQ_URI_HTTP': 1, '__FPR_HEADER_331091_683269': 1, '__FPR_HEADER_27""" \
"""1199_640554': 1, '__HW_H_TO_NO_REAL_NAME': 1, '__RCVD_WEBMAIL': 1, '__FPR_HEADER_374137_705598': 1, '__HAS_MSGID': 1,""" \
""" '__HELO_RCVD_AZ': 1, '__XMAILER_OUTLOOK': 1, '__IP_DF_MISC_OB_TO': 1, '__FPR_HEADER_332727_683961': 1, '__CT_US_ASCI""" \
"""I': 1, '__FPR_HEADER_342974_688453': 1, 'ZBL_HAS_OUTLOOK_IN_MAILER': 1, '__THREAD_INDEX_SHORT': 1, '__HAS_RCVD': 1, '""" \
"""__ANY_MICROSOFT': 1, '__FPR_HEADER_371214_704149': 1, '__CT': 1, '__ES_BODY_HTTP_COLON_SLASH_SLASH': 1, '__PRODUCED_B""" \
"""Y_MS_OLE': 1, 'ZBL_PRODUCED_BY_MS_OLE': 1, 'ZBL_THREAD_INDEX_SHORT': 1, 'ZBL_TO_HAS_ANGLE_BR': 1, '__MISSING_REPLY': """ \
"""1, '__HAS_DATE': 1, '__CM_MSGID_REPEATS': 1, '__FPR_HEADER_373200_705158': 1, '__TO_ADDRESS_BRACKETED_NO_NAME': 1, '_""" \
"""_FPR_HEADER_374446_705764': 1, '__FPR_BODY_348060_690936': 1}, 'IPAS_SCORE': 100, 'VOF_SCORE': 0, 'VOF_FILENAMES': []""" \
""", 'URL_EXISTS': 1}, 'SBNP_AV': {'IP': {'0.0.0.0': {}}}}
"""

gtube_process_resp = \
"""SPAMD/1.1 0 EX_OK\r
Content-length: 3947\r
Spam: True ; 998.6 / 5.0\r
\r
Received: from localhost by blade18.soma.ironport.com
	with SpamAssassin (version 3.2.0);
	Fri, 10 Feb 2012 13:44:20 -0800
From: "Taras Todosiychuk" <taras@ironport.com>
To: <konstantin@ironport.com>
Subject: test
Date: Tue, 3 Jan 2006 16:57:15 +0200
Message-Id: <WEBMAILix4A2DreBBsQ00000022@webmail.ironportsystems.com>
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2011-05-12) on
	blade18.soma.ironport.com
X-Spam-Flag: YES
X-Spam-Level: **************************************************
X-Spam-Status: Yes, score=998.6 required=5.0 tests=ALL_TRUSTED,GTUBE,
	IP_DQ_MSGID_0000_HEX4,IP_DQ_MSOE_CLONE_RCVD_3,ZBL_ANY_MICROSOFT,
	ZBL_CT_US_ASCII,ZBL_HAS_OUTLOOK_IN_MAILER,ZBL_HAS_THREAD_INDEX,
	ZBL_IMG_TXTR_13_14,ZBL_OUTLOOK_EUDORA,ZBL_PRODUCED_BY_MS_OLE,
	ZBL_RELAY_FIRST_FROM_AZ_3_7,ZBL_SUBJECT_LOWER_WORDS,
	ZBL_SUBJ_SHORT_RANDOM_WORD,ZBL_THREAD_INDEX_GOOD,ZBL_THREAD_INDEX_SHORT,
	ZBL_TO_HAS_ANGLE_BR,ZBL_XMAILER_OUTLOOK autolearn=unavailable version=3.2.0
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="----------=_4F358FB4.A5DB20FA"

This is a multi-part message in MIME format.

------------=_4F358FB4.A5DB20FA
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

Spam detection software, running on the system "blade18.soma.ironport.com", has
identified this incoming email as possible spam.  The original message
has been attached to this so you can view it (if it isn't spam) or label
similar future email.  If you have any questions, see
@@CONTACT_ADDRESS@@ for details.

Content preview:  http://rambler.ru test XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
   [...] 

Content analysis details:   (998.6 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
-1.4 ALL_TRUSTED            ALL_TRUSTED
 0.0 IP_DQ_MSGID_0000_HEX4  IP_DQ_MSGID_0000_HEX4
 0.0 IP_DQ_MSOE_CLONE_RCVD_3 IP_DQ_MSOE_CLONE_RCVD_3
 0.0 ZBL_CT_US_ASCII        ZBL_CT_US_ASCII
 0.0 ZBL_RELAY_FIRST_FROM_AZ_3_7 ZBL_RELAY_FIRST_FROM_AZ_3_7
 0.0 ZBL_HAS_THREAD_INDEX   ZBL_HAS_THREAD_INDEX
 0.0 ZBL_THREAD_INDEX_GOOD  ZBL_THREAD_INDEX_GOOD
 0.0 ZBL_THREAD_INDEX_SHORT ZBL_THREAD_INDEX_SHORT
 0.0 ZBL_XMAILER_OUTLOOK    ZBL_XMAILER_OUTLOOK
 0.0 ZBL_OUTLOOK_EUDORA     ZBL_OUTLOOK_EUDORA
 0.0 ZBL_ANY_MICROSOFT      ZBL_ANY_MICROSOFT
 0.0 ZBL_HAS_OUTLOOK_IN_MAILER ZBL_HAS_OUTLOOK_IN_MAILER
 0.0 ZBL_PRODUCED_BY_MS_OLE ZBL_PRODUCED_BY_MS_OLE
 0.0 ZBL_IMG_TXTR_13_14     ZBL_IMG_TXTR_13_14
 0.0 ZBL_SUBJECT_LOWER_WORDS ZBL_SUBJECT_LOWER_WORDS
 0.0 ZBL_SUBJ_SHORT_RANDOM_WORD ZBL_SUBJ_SHORT_RANDOM_WORD
 0.0 ZBL_TO_HAS_ANGLE_BR    ZBL_TO_HAS_ANGLE_BR
1000 GTUBE                  BODY: GTUBE



------------=_4F358FB4.A5DB20FA
Content-Type: message/rfc822; x-spam-type=original
Content-Description: original message before SpamAssassin
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

Received: from webmail.ironportsystems.com ([10.1.1.155]) by anakin.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
Received: from trino ([10.1.1.209]) by webmail.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
From: "Taras Todosiychuk" <taras@ironport.com>
To: <konstantin@ironport.com>
Subject: test
Date: Tue, 3 Jan 2006 16:57:15 +0200
MIME-Version: 1.0
Content-Type: text/plain;
    charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Mailer: Microsoft Office Outlook, Build 11.0.6353
Thread-Index: AcYQdfvaWdu6CJENR6aAPKal5UIHHg==
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1506
Return-Path: taras@ironport.com
Message-ID: <WEBMAILix4A2DreBBsQ00000022@webmail.ironportsystems.com>
X-OriginalArrivalTime: 03 Jan 2006 14:57:41.0796 (UTC) FILETIME=[0BDE9640:01C61076]


http://rambler.ru
test

XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X

------------=_4F358FB4.A5DB20FA--
 
"""

gtube_process_result = \
"""response: 0 : EX_OK
spamd version: 1.1
is_spam: True
score: 998.6
threshold: 5.0
ipas_score: None
case: None
length: 3947
EMAIL:

Received: from localhost by blade18.soma.ironport.com
	with SpamAssassin (version 3.2.0);
	Fri, 10 Feb 2012 13:44:20 -0800
From: "Taras Todosiychuk" <taras@ironport.com>
To: <konstantin@ironport.com>
Subject: test
Date: Tue, 3 Jan 2006 16:57:15 +0200
Message-Id: <WEBMAILix4A2DreBBsQ00000022@webmail.ironportsystems.com>
X-Spam-Checker-Version: SpamAssassin 3.2.0 (2011-05-12) on
	blade18.soma.ironport.com
X-Spam-Flag: YES
X-Spam-Level: **************************************************
X-Spam-Status: Yes, score=998.6 required=5.0 tests=ALL_TRUSTED,GTUBE,
	IP_DQ_MSGID_0000_HEX4,IP_DQ_MSOE_CLONE_RCVD_3,ZBL_ANY_MICROSOFT,
	ZBL_CT_US_ASCII,ZBL_HAS_OUTLOOK_IN_MAILER,ZBL_HAS_THREAD_INDEX,
	ZBL_IMG_TXTR_13_14,ZBL_OUTLOOK_EUDORA,ZBL_PRODUCED_BY_MS_OLE,
	ZBL_RELAY_FIRST_FROM_AZ_3_7,ZBL_SUBJECT_LOWER_WORDS,
	ZBL_SUBJ_SHORT_RANDOM_WORD,ZBL_THREAD_INDEX_GOOD,ZBL_THREAD_INDEX_SHORT,
	ZBL_TO_HAS_ANGLE_BR,ZBL_XMAILER_OUTLOOK autolearn=unavailable version=3.2.0
MIME-Version: 1.0
Content-Type: multipart/mixed; boundary="----------=_4F358FB4.A5DB20FA"

This is a multi-part message in MIME format.

------------=_4F358FB4.A5DB20FA
Content-Type: text/plain; charset=iso-8859-1
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

Spam detection software, running on the system "blade18.soma.ironport.com", has
identified this incoming email as possible spam.  The original message
has been attached to this so you can view it (if it isn't spam) or label
similar future email.  If you have any questions, see
@@CONTACT_ADDRESS@@ for details.

Content preview:  http://rambler.ru test XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X
   [...] 

Content analysis details:   (998.6 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
-1.4 ALL_TRUSTED            ALL_TRUSTED
 0.0 IP_DQ_MSGID_0000_HEX4  IP_DQ_MSGID_0000_HEX4
 0.0 IP_DQ_MSOE_CLONE_RCVD_3 IP_DQ_MSOE_CLONE_RCVD_3
 0.0 ZBL_CT_US_ASCII        ZBL_CT_US_ASCII
 0.0 ZBL_RELAY_FIRST_FROM_AZ_3_7 ZBL_RELAY_FIRST_FROM_AZ_3_7
 0.0 ZBL_HAS_THREAD_INDEX   ZBL_HAS_THREAD_INDEX
 0.0 ZBL_THREAD_INDEX_GOOD  ZBL_THREAD_INDEX_GOOD
 0.0 ZBL_THREAD_INDEX_SHORT ZBL_THREAD_INDEX_SHORT
 0.0 ZBL_XMAILER_OUTLOOK    ZBL_XMAILER_OUTLOOK
 0.0 ZBL_OUTLOOK_EUDORA     ZBL_OUTLOOK_EUDORA
 0.0 ZBL_ANY_MICROSOFT      ZBL_ANY_MICROSOFT
 0.0 ZBL_HAS_OUTLOOK_IN_MAILER ZBL_HAS_OUTLOOK_IN_MAILER
 0.0 ZBL_PRODUCED_BY_MS_OLE ZBL_PRODUCED_BY_MS_OLE
 0.0 ZBL_IMG_TXTR_13_14     ZBL_IMG_TXTR_13_14
 0.0 ZBL_SUBJECT_LOWER_WORDS ZBL_SUBJECT_LOWER_WORDS
 0.0 ZBL_SUBJ_SHORT_RANDOM_WORD ZBL_SUBJ_SHORT_RANDOM_WORD
 0.0 ZBL_TO_HAS_ANGLE_BR    ZBL_TO_HAS_ANGLE_BR
1000 GTUBE                  BODY: GTUBE



------------=_4F358FB4.A5DB20FA
Content-Type: message/rfc822; x-spam-type=original
Content-Description: original message before SpamAssassin
Content-Disposition: inline
Content-Transfer-Encoding: 8bit

Received: from webmail.ironportsystems.com ([10.1.1.155]) by anakin.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
Received: from trino ([10.1.1.209]) by webmail.ironportsystems.com with Microsoft SMTPSVC(6.0.3790.1830);
     Tue, 3 Jan 2006 06:57:41 -0800
From: "Taras Todosiychuk" <taras@ironport.com>
To: <konstantin@ironport.com>
Subject: test
Date: Tue, 3 Jan 2006 16:57:15 +0200
MIME-Version: 1.0
Content-Type: text/plain;
    charset="US-ASCII"
Content-Transfer-Encoding: 7bit
X-Mailer: Microsoft Office Outlook, Build 11.0.6353
Thread-Index: AcYQdfvaWdu6CJENR6aAPKal5UIHHg==
X-MimeOLE: Produced By Microsoft MimeOLE V6.00.2800.1506
Return-Path: taras@ironport.com
Message-ID: <WEBMAILix4A2DreBBsQ00000022@webmail.ironportsystems.com>
X-OriginalArrivalTime: 03 Jan 2006 14:57:41.0796 (UTC) FILETIME=[0BDE9640:01C61076]


http://rambler.ru
test

XJS*C4JDBQADN1.NSBN3*2IDNEN*GTUBE-STANDARD-ANTI-UBE-TEST-EMAIL*C.34X

------------=_4F358FB4.A5DB20FA--
 
"""

rpc_check_resp = \
"""SPAMD/1.1 0 EX_OK\r
Spam: True ; 998.6 / 5.0\r
X-IronPort-MGA: d3:MGAd18:IPAS_RESULT_STRING64:Av//AAbflk4AAAAA/2dsb2JhbAAMgmqFQoEsoTgyTAUqPhoJFQQDAQQewE6gGYwQ16:IPAS_R""" \
"""ULES_COUNTd11:ALL_TRUSTEDi1e5:GTUBEi1e21:IP_DQ_MSGID_0000_HEX4i1e23:IP_DQ_MSOE_CLONE_RCVD_3i1e17:ZBL_ANY_MICROSOFTi1e""" \
"""15:ZBL_CT_US_ASCIIi1e25:ZBL_HAS_OUTLOOK_IN_MAILERi1e20:ZBL_HAS_THREAD_INDEXi1e18:ZBL_IMG_TXTR_13_14i1e18:ZBL_OUTLOOK_""" \
"""EUDORAi1e22:ZBL_PRODUCED_BY_MS_OLEi1e27:ZBL_RELAY_FIRST_FROM_AZ_3_7i1e23:ZBL_SUBJECT_LOWER_WORDSi1e26:ZBL_SUBJ_SHORT_""" \
"""RANDOM_WORDi1e21:ZBL_THREAD_INDEX_GOODi1e22:ZBL_THREAD_INDEX_SHORTi1e19:ZBL_TO_HAS_ANGLE_BRi1e19:ZBL_XMAILER_OUTLOOKi""" \
"""1e20:__AK_RCVD_LACKS_HELOi1e20:__AK_RCVD_LACKS_RDNSi1e15:__ANY_MICROSOFTi1e18:__CM_MSGID_REPEATSi1e19:__CM_NO_YAHOO_C""" \
"""O_JPi1e30:__CM_OUTLOOK_11_0_6353_XMAILERi1e4:__CTi1e5:__CTEi1e10:__CTE_7BITi1e15:__CT_TEXT_PLAINi1e13:__CT_US_ASCIIi1""" \
"""e20:__E2_KB_SOME_SUBJECTi1e32:__ES_BODY_HTTP_COLON_SLASH_SLASHi1e24:__FPR_BODY_348060_690936i1e26:__FPR_HEADER_228918""" \
"""_555162i1e26:__FPR_HEADER_250910_592020i1e26:__FPR_HEADER_258026_607859i1e26:__FPR_HEADER_261091_615742i1e26:__FPR_HE""" \
"""ADER_262542_618996i1e26:__FPR_HEADER_267187_630373i1e26:__FPR_HEADER_267406_630949i1e26:__FPR_HEADER_267406_630952i1e""" \
"""26:__FPR_HEADER_271199_640554i1e26:__FPR_HEADER_272471_643634i1e26:__FPR_HEADER_287303_661141i1e26:__FPR_HEADER_29475""" \
"""9_664991i1e26:__FPR_HEADER_294759_664993i1e26:__FPR_HEADER_298948_667093i1e26:__FPR_HEADER_322729_679758i1e26:__FPR_H""" \
"""EADER_331091_683269i1e26:__FPR_HEADER_332514_683882i1e26:__FPR_HEADER_332727_683961i1e26:__FPR_HEADER_340385_687339i1""" \
"""e26:__FPR_HEADER_342974_688453i1e26:__FPR_HEADER_345997_689891i1e26:__FPR_HEADER_348259_691037i1e26:__FPR_HEADER_3486""" \
"""91_691261i1e26:__FPR_HEADER_348691_691264i1e26:__FPR_HEADER_352725_693662i1e26:__FPR_HEADER_353482_694137i1e26:__FPR_""" \
"""HEADER_355550_695416i1e26:__FPR_HEADER_356464_696001i1e26:__FPR_HEADER_357218_696552i1e26:__FPR_HEADER_360190_698240i""" \
"""1e26:__FPR_HEADER_360404_698393i1e26:__FPR_HEADER_363112_699945i1e26:__FPR_HEADER_363112_699950i1e26:__FPR_HEADER_363""" \
"""466_700153i1e26:__FPR_HEADER_367777_702514i1e26:__FPR_HEADER_369344_703336i1e26:__FPR_HEADER_371214_704149i1e26:__FPR""" \
"""_HEADER_371214_704150i1e26:__FPR_HEADER_371214_704151i1e26:__FPR_HEADER_371214_704153i1e26:__FPR_HEADER_373200_705158""" \
"""i1e26:__FPR_HEADER_374137_705598i1e26:__FPR_HEADER_374446_705764i1e19:__FROM_HAS_ANGLE_BRi1e20:__FROM_NAME_NO_LOCALi1""" \
"""e13:__FROM_REPEATi1e19:__FROM_REPEAT_OKAY4i1e16:__GLM_BODY_EMAILi1e16:__HAS_CT_CHARSETi1e10:__HAS_DATEi1e16:__HAS_MES""" \
"""SAGE_IDi1e13:__HAS_MIMEOLEi1e11:__HAS_MSGIDi1e23:__HAS_OUTLOOK_IN_MAILERi1e10:__HAS_RCVDi1e13:__HAS_SUBJECTi1e18:__HA""" \
"""S_THREAD_INDEXi1e8:__HAS_TOi1e13:__HAS_TRUSTEDi1e14:__HAS_X_MAILERi1e27:__HAS_X_ORIGINALARRIVALTIMEi1e14:__HELO_RCVD_""" \
"""AZi1e22:__HW_H_TO_NO_REAL_NAMEi1e16:__IMG_TXTR_13_14i1e18:__IP_DF_MISC_OB_TOi1e20:__IP_KB_GOOD_HEADERSi1e23:__IRONPOR""" \
"""TSYSTEMS_MSGIDi1e14:__MID_INTL_TLDi1e14:__MIME_VERSIONi1e15:__MISSING_REPLYi1e14:__MSFT_SMTPSVCi1e15:__MSGID_OK_HOSTi""" \
"""1e18:__NONEMPTY_RAWBODYi1e24:__NOT_MSGID_LEGIT_OL_WUBi1e16:__OUTLOOK_EUDORAi1e20:__PRODUCED_BY_MS_OLEi1e14:__RCVD_WEB""" \
"""MAILi1e25:__RELAY_FIRST_FROM_AZ_3_7i1e13:__RL_CTE_7BITi1e12:__SANE_MSGIDi1e38:__SPAMMY_XMAILERS_FOR_RCVD_FROM_IPADDRi""" \
"""1e12:__START_HTTPi1e21:__SUBJECT_LOWER_WORDSi1e21:__SUBJECT_NONE_OR_ONEi1e24:__SUBJ_SHORT_RANDOM_WORDi1e19:__THREAD_I""" \
"""NDEX_GOODi1e20:__THREAD_INDEX_SHORTi1e13:__TOCC_EXISTSi1e30:__TO_ADDRESS_BRACKETED_NO_NAMEi1e17:__TO_HAS_ANGLE_BRi1e1""" \
"""7:__TO_NO_REAL_NAMEi1e10:__URI_HTTPi1e26:__URI_NAME_TOPLEVEL_NON_USi1e17:__VERY_SANE_MSGIDi1e17:__XMAILER_OUTLOOKi1e1""" \
"""3:__ZQ_URI_HTTPi1e12:___HAS_MSGIDi1e31:___PL_RCVD_MSNORLIVEORMICROSOFTi1e10:___TZ_0200i1ee10:IPAS_SCOREi100e10:URL_EX""" \
"""ISTSi1e13:VOF_FILENAMESlee4:SBNPd10:CONNECTIONd7:0.0.0.0d5:FUZZYd2:V9d80:ylaqZ07e3gaWyJo++L3itPZGcfIYtP4BYlXB+wy5KQeM""" \
"""zDfYSootx+FOnja+/vR3tDOnoxO/nYkAwA==d5:COUNTi1e3:EESi1e4:FROMd4:3EgSi1ee8:IPAS_URLd10:rambler.rui1ee5:SCOREi100e2:TOd""" \
"""4:4uoki1ee5:URIDBd0:i1eeeee18:IPAS_MESSAGE_COUNTi1eee18:DID_INCOMING_RELAYi0e2:IPd7:0.0.0.0d18:IPAS_MESSAGE_COUNTi1e1""" \
"""6:IPAS_SCORE_LOCALi100eee16:IPAS_RULES_COUNTd11:ALL_TRUSTEDi1e5:GTUBEi1e21:IP_DQ_MSGID_0000_HEX4i1e23:IP_DQ_MSOE_CLON""" \
"""E_RCVD_3i1e17:ZBL_ANY_MICROSOFTi1e15:ZBL_CT_US_ASCIIi1e25:ZBL_HAS_OUTLOOK_IN_MAILERi1e20:ZBL_HAS_THREAD_INDEXi1e18:ZB""" \
"""L_IMG_TXTR_13_14i1e18:ZBL_OUTLOOK_EUDORAi1e22:ZBL_PRODUCED_BY_MS_OLEi1e27:ZBL_RELAY_FIRST_FROM_AZ_3_7i1e23:ZBL_SUBJEC""" \
"""T_LOWER_WORDSi1e26:ZBL_SUBJ_SHORT_RANDOM_WORDi1e21:ZBL_THREAD_INDEX_GOODi1e22:ZBL_THREAD_INDEX_SHORTi1e19:ZBL_TO_HAS_""" \
"""ANGLE_BRi1e19:ZBL_XMAILER_OUTLOOKi1e20:__AK_RCVD_LACKS_HELOi1e20:__AK_RCVD_LACKS_RDNSi1e15:__ANY_MICROSOFTi1e18:__CM_""" \
"""MSGID_REPEATSi1e19:__CM_NO_YAHOO_CO_JPi1e30:__CM_OUTLOOK_11_0_6353_XMAILERi1e4:__CTi1e5:__CTEi1e10:__CTE_7BITi1e15:__""" \
"""CT_TEXT_PLAINi1e13:__CT_US_ASCIIi1e20:__E2_KB_SOME_SUBJECTi1e32:__ES_BODY_HTTP_COLON_SLASH_SLASHi1e24:__FPR_BODY_3480""" \
"""60_690936i1e26:__FPR_HEADER_228918_555162i1e26:__FPR_HEADER_250910_592020i1e26:__FPR_HEADER_258026_607859i1e26:__FPR_""" \
"""HEADER_261091_615742i1e26:__FPR_HEADER_262542_618996i1e26:__FPR_HEADER_267187_630373i1e26:__FPR_HEADER_267406_630949i""" \
"""1e26:__FPR_HEADER_267406_630952i1e26:__FPR_HEADER_271199_640554i1e26:__FPR_HEADER_272471_643634i1e26:__FPR_HEADER_287""" \
"""303_661141i1e26:__FPR_HEADER_294759_664991i1e26:__FPR_HEADER_294759_664993i1e26:__FPR_HEADER_298948_667093i1e26:__FPR""" \
"""_HEADER_322729_679758i1e26:__FPR_HEADER_331091_683269i1e26:__FPR_HEADER_332514_683882i1e26:__FPR_HEADER_332727_683961""" \
"""i1e26:__FPR_HEADER_340385_687339i1e26:__FPR_HEADER_342974_688453i1e26:__FPR_HEADER_345997_689891i1e26:__FPR_HEADER_34""" \
"""8259_691037i1e26:__FPR_HEADER_348691_691261i1e26:__FPR_HEADER_348691_691264i1e26:__FPR_HEADER_352725_693662i1e26:__FP""" \
"""R_HEADER_353482_694137i1e26:__FPR_HEADER_355550_695416i1e26:__FPR_HEADER_356464_696001i1e26:__FPR_HEADER_357218_69655""" \
"""2i1e26:__FPR_HEADER_360190_698240i1e26:__FPR_HEADER_360404_698393i1e26:__FPR_HEADER_363112_699945i1e26:__FPR_HEADER_3""" \
"""63112_699950i1e26:__FPR_HEADER_363466_700153i1e26:__FPR_HEADER_367777_702514i1e26:__FPR_HEADER_369344_703336i1e26:__F""" \
"""PR_HEADER_371214_704149i1e26:__FPR_HEADER_371214_704150i1e26:__FPR_HEADER_371214_704151i1e26:__FPR_HEADER_371214_7041""" \
"""53i1e26:__FPR_HEADER_373200_705158i1e26:__FPR_HEADER_374137_705598i1e26:__FPR_HEADER_374446_705764i1e19:__FROM_HAS_AN""" \
"""GLE_BRi1e20:__FROM_NAME_NO_LOCALi1e13:__FROM_REPEATi1e19:__FROM_REPEAT_OKAY4i1e16:__GLM_BODY_EMAILi1e16:__HAS_CT_CHAR""" \
"""SETi1e10:__HAS_DATEi1e16:__HAS_MESSAGE_IDi1e13:__HAS_MIMEOLEi1e11:__HAS_MSGIDi1e23:__HAS_OUTLOOK_IN_MAILERi1e10:__HAS""" \
"""_RCVDi1e13:__HAS_SUBJECTi1e18:__HAS_THREAD_INDEXi1e8:__HAS_TOi1e13:__HAS_TRUSTEDi1e14:__HAS_X_MAILERi1e27:__HAS_X_ORI""" \
"""GINALARRIVALTIMEi1e14:__HELO_RCVD_AZi1e22:__HW_H_TO_NO_REAL_NAMEi1e16:__IMG_TXTR_13_14i1e18:__IP_DF_MISC_OB_TOi1e20:_""" \
"""_IP_KB_GOOD_HEADERSi1e23:__IRONPORTSYSTEMS_MSGIDi1e14:__MID_INTL_TLDi1e14:__MIME_VERSIONi1e15:__MISSING_REPLYi1e14:__""" \
"""MSFT_SMTPSVCi1e15:__MSGID_OK_HOSTi1e18:__NONEMPTY_RAWBODYi1e24:__NOT_MSGID_LEGIT_OL_WUBi1e16:__OUTLOOK_EUDORAi1e20:__""" \
"""PRODUCED_BY_MS_OLEi1e14:__RCVD_WEBMAILi1e25:__RELAY_FIRST_FROM_AZ_3_7i1e13:__RL_CTE_7BITi1e12:__SANE_MSGIDi1e38:__SPA""" \
"""MMY_XMAILERS_FOR_RCVD_FROM_IPADDRi1e12:__START_HTTPi1e21:__SUBJECT_LOWER_WORDSi1e21:__SUBJECT_NONE_OR_ONEi1e24:__SUBJ""" \
"""_SHORT_RANDOM_WORDi1e19:__THREAD_INDEX_GOODi1e20:__THREAD_INDEX_SHORTi1e13:__TOCC_EXISTSi1e30:__TO_ADDRESS_BRACKETED_""" \
"""NO_NAMEi1e17:__TO_HAS_ANGLE_BRi1e17:__TO_NO_REAL_NAMEi1e10:__URI_HTTPi1e26:__URI_NAME_TOPLEVEL_NON_USi1e17:__VERY_SAN""" \
"""E_MSGIDi1e17:__XMAILER_OUTLOOKi1e13:__ZQ_URI_HTTPi1e12:___HAS_MSGIDi1e31:___PL_RCVD_MSNORLIVEORMICROSOFTi1e10:___TZ_0""" \
"""200i1ee24:IPAS_RULES_MESSAGE_COUNTi1e24:IPAS_SPAM_POSITIVE_LIMITi75e23:IPAS_SPAM_SUSPECT_LIMITi50e14:REGION_PROFILE6:""" \
"""global13:SERIAL_NUMBERd10:2011090800i1eee7:SBNP_AVd2:IPd7:0.0.0.0deeee\r
X-IronPort-IPAS-Score: 100\r
\r
\r"""

rpc_check_result = \
"""response: 0 : EX_OK
spamd version: 1.1
is_spam: True
score: 998.6
threshold: 5.0
ipas_score: 100
case: {'SBNP': {'IP': {'0.0.0.0': {'IPAS_SCORE_LOCAL': 100, 'IPAS_MESSAGE_COUNT': 1}}, 'IPAS_SPAM_SUSPECT_LIMIT': 50, 'D""" \
"""ID_INCOMING_RELAY': 0, 'IPAS_RULES_COUNT': {'__FPR_HEADER_363112_699950': 1, 'ZBL_RELAY_FIRST_FROM_AZ_3_7': 1, '__HAS""" \
"""_TO': 1, '__URI_HTTP': 1, '__FPR_HEADER_371214_704151': 1, '__CTE': 1, '__FPR_HEADER_371214_704153': 1, '__SPAMMY_XMA""" \
"""ILERS_FOR_RCVD_FROM_IPADDR': 1, '__FROM_NAME_NO_LOCAL': 1, '__FPR_HEADER_258026_607859': 1, '__GLM_BODY_EMAIL': 1, '_""" \
"""_FPR_HEADER_298948_667093': 1, 'ALL_TRUSTED': 1, 'ZBL_CT_US_ASCII': 1, '__NOT_MSGID_LEGIT_OL_WUB': 1, '__FPR_HEADER_3""" \
"""63112_699945': 1, 'IP_DQ_MSOE_CLONE_RCVD_3': 1, '__FPR_HEADER_267406_630952': 1, '__FPR_HEADER_348691_691264': 1, '__""" \
"""HAS_THREAD_INDEX': 1, '__FPR_HEADER_348691_691261': 1, '__NONEMPTY_RAWBODY': 1, '__FPR_HEADER_261091_615742': 1, '__C""" \
"""TE_7BIT': 1, '__CM_NO_YAHOO_CO_JP': 1, '__IP_KB_GOOD_HEADERS': 1, '__FPR_HEADER_371214_704150': 1, 'ZBL_ANY_MICROSOFT""" \
"""': 1, 'ZBL_IMG_TXTR_13_14': 1, '__HAS_OUTLOOK_IN_MAILER': 1, 'ZBL_SUBJECT_LOWER_WORDS': 1, '__TO_NO_REAL_NAME': 1, '_""" \
"""_FPR_HEADER_267406_630949': 1, '__FPR_HEADER_363466_700153': 1, '__FPR_HEADER_294759_664993': 1, '__FPR_HEADER_294759""" \
"""_664991': 1, '__SUBJECT_LOWER_WORDS': 1, '__FPR_HEADER_340385_687339': 1, '__FPR_HEADER_355550_695416': 1, '__FPR_HEA""" \
"""DER_267187_630373': 1, '__RELAY_FIRST_FROM_AZ_3_7': 1, '__FROM_REPEAT': 1, '__AK_RCVD_LACKS_HELO': 1, '__MSFT_SMTPSVC""" \
"""': 1, '___TZ_0200': 1, '__FPR_HEADER_348259_691037': 1, '__FPR_HEADER_332514_683882': 1, '___HAS_MSGID': 1, '__MIME_V""" \
"""ERSION': 1, '__AK_RCVD_LACKS_RDNS': 1, '__FPR_HEADER_250910_592020': 1, '__CT_TEXT_PLAIN': 1, '__FPR_HEADER_357218_69""" \
"""6552': 1, '__VERY_SANE_MSGID': 1, '__FPR_HEADER_353482_694137': 1, '__FPR_HEADER_228918_555162': 1, 'ZBL_THREAD_INDEX""" \
"""_GOOD': 1, '__HAS_X_ORIGINALARRIVALTIME': 1, '__E2_KB_SOME_SUBJECT': 1, '__HAS_X_MAILER': 1, '__START_HTTP': 1, 'ZBL_""" \
"""SUBJ_SHORT_RANDOM_WORD': 1, '__HAS_MESSAGE_ID': 1, '__URI_NAME_TOPLEVEL_NON_US': 1, 'GTUBE': 1, '__FPR_HEADER_262542_""" \
"""618996': 1, '__FPR_HEADER_369344_703336': 1, 'IP_DQ_MSGID_0000_HEX4': 1, '__HAS_TRUSTED': 1, '__FPR_HEADER_360404_698""" \
"""393': 1, '__HAS_SUBJECT': 1, 'ZBL_OUTLOOK_EUDORA': 1, 'ZBL_XMAILER_OUTLOOK': 1, '__IMG_TXTR_13_14': 1, '__SANE_MSGID'""" \
""": 1, '___PL_RCVD_MSNORLIVEORMICROSOFT': 1, '__SUBJECT_NONE_OR_ONE': 1, '__FROM_HAS_ANGLE_BR': 1, '__CM_OUTLOOK_11_0_6""" \
"""353_XMAILER': 1, '__SUBJ_SHORT_RANDOM_WORD': 1, '__TO_HAS_ANGLE_BR': 1, '__TOCC_EXISTS': 1, '__FPR_HEADER_352725_6936""" \
"""62': 1, '__HAS_CT_CHARSET': 1, '__FROM_REPEAT_OKAY4': 1, '__RL_CTE_7BIT': 1, '__MSGID_OK_HOST': 1, '__FPR_HEADER_2724""" \
"""71_643634': 1, '__THREAD_INDEX_GOOD': 1, '__MID_INTL_TLD': 1, '__HAS_MIMEOLE': 1, '__FPR_HEADER_356464_696001': 1, '_""" \
"""_FPR_HEADER_322729_679758': 1, '__FPR_HEADER_287303_661141': 1, '__FPR_HEADER_345997_689891': 1, '__FPR_HEADER_367777""" \
"""_702514': 1, '__IRONPORTSYSTEMS_MSGID': 1, '__FPR_HEADER_360190_698240': 1, '__OUTLOOK_EUDORA': 1, 'ZBL_HAS_THREAD_IN""" \
"""DEX': 1, '__ZQ_URI_HTTP': 1, '__FPR_HEADER_331091_683269': 1, '__FPR_HEADER_271199_640554': 1, '__HW_H_TO_NO_REAL_NAM""" \
"""E': 1, '__RCVD_WEBMAIL': 1, '__FPR_HEADER_374137_705598': 1, '__HAS_MSGID': 1, '__HELO_RCVD_AZ': 1, '__XMAILER_OUTLOO""" \
"""K': 1, '__IP_DF_MISC_OB_TO': 1, '__FPR_HEADER_332727_683961': 1, '__CT_US_ASCII': 1, '__FPR_HEADER_342974_688453': 1,""" \
""" 'ZBL_HAS_OUTLOOK_IN_MAILER': 1, '__THREAD_INDEX_SHORT': 1, '__HAS_RCVD': 1, '__ANY_MICROSOFT': 1, '__FPR_HEADER_3712""" \
"""14_704149': 1, '__CT': 1, '__ES_BODY_HTTP_COLON_SLASH_SLASH': 1, '__PRODUCED_BY_MS_OLE': 1, 'ZBL_PRODUCED_BY_MS_OLE':""" \
""" 1, 'ZBL_THREAD_INDEX_SHORT': 1, 'ZBL_TO_HAS_ANGLE_BR': 1, '__MISSING_REPLY': 1, '__HAS_DATE': 1, '__CM_MSGID_REPEATS""" \
"""': 1, '__FPR_HEADER_373200_705158': 1, '__TO_ADDRESS_BRACKETED_NO_NAME': 1, '__FPR_HEADER_374446_705764': 1, '__FPR_B""" \
"""ODY_348060_690936': 1}, 'CONNECTION': {'0.0.0.0': {'FUZZY': {'V9': {'ylaqZ07e3gaWyJo++L3itPZGcfIYtP4BYlXB+wy5KQeMzDfY""" \
"""Sootx+FOnja+/vR3tDOnoxO/nYkAwA==': {'COUNT': 1, 'FROM': {'3EgS': 1}, 'TO': {'4uok': 1}, 'URIDB': {'': 1}, 'EES': 1, '""" \
"""IPAS_URL': {'rambler.ru': 1}, 'SCORE': 100}}}, 'IPAS_MESSAGE_COUNT': 1}}, 'IPAS_SPAM_POSITIVE_LIMIT': 75, 'REGION_PRO""" \
"""FILE': 'global', 'SERIAL_NUMBER': {'2011090800': 1}, 'IPAS_RULES_MESSAGE_COUNT': 1}, 'MGA': {'IPAS_SCORE': 100, 'VOF_""" \
"""FILENAMES': [], 'URL_EXISTS': 1, 'IPAS_RESULT_STRING': 'Av//AAbflk4AAAAA/2dsb2JhbAAMgmqFQoEsoTgyTAUqPhoJFQQDAQQewE6gG""" \
"""YwQ', 'IPAS_RULES_COUNT': {'__FPR_HEADER_363112_699950': 1, 'ZBL_RELAY_FIRST_FROM_AZ_3_7': 1, '__HAS_TO': 1, '__URI_H""" \
"""TTP': 1, '__FPR_HEADER_371214_704151': 1, '__CTE': 1, '__FPR_HEADER_371214_704153': 1, '__SPAMMY_XMAILERS_FOR_RCVD_FR""" \
"""OM_IPADDR': 1, '__FROM_NAME_NO_LOCAL': 1, '__FPR_HEADER_258026_607859': 1, '__GLM_BODY_EMAIL': 1, '__FPR_HEADER_29894""" \
"""8_667093': 1, 'ALL_TRUSTED': 1, 'ZBL_CT_US_ASCII': 1, '__NOT_MSGID_LEGIT_OL_WUB': 1, '__FPR_HEADER_363112_699945': 1,""" \
""" 'IP_DQ_MSOE_CLONE_RCVD_3': 1, '__FPR_HEADER_267406_630952': 1, '__FPR_HEADER_348691_691264': 1, '__HAS_THREAD_INDEX'""" \
""": 1, '__FPR_HEADER_348691_691261': 1, '__NONEMPTY_RAWBODY': 1, '__FPR_HEADER_261091_615742': 1, '__CTE_7BIT': 1, '__C""" \
"""M_NO_YAHOO_CO_JP': 1, '__IP_KB_GOOD_HEADERS': 1, '__FPR_HEADER_371214_704150': 1, 'ZBL_ANY_MICROSOFT': 1, 'ZBL_IMG_TX""" \
"""TR_13_14': 1, '__HAS_OUTLOOK_IN_MAILER': 1, 'ZBL_SUBJECT_LOWER_WORDS': 1, '__TO_NO_REAL_NAME': 1, '__FPR_HEADER_26740""" \
"""6_630949': 1, '__FPR_HEADER_363466_700153': 1, '__FPR_HEADER_294759_664993': 1, '__FPR_HEADER_294759_664991': 1, '__S""" \
"""UBJECT_LOWER_WORDS': 1, '__FPR_HEADER_340385_687339': 1, '__FPR_HEADER_355550_695416': 1, '__FPR_HEADER_267187_630373""" \
"""': 1, '__RELAY_FIRST_FROM_AZ_3_7': 1, '__FROM_REPEAT': 1, '__AK_RCVD_LACKS_HELO': 1, '__MSFT_SMTPSVC': 1, '___TZ_0200""" \
"""': 1, '__FPR_HEADER_348259_691037': 1, '__FPR_HEADER_332514_683882': 1, '___HAS_MSGID': 1, '__MIME_VERSION': 1, '__AK""" \
"""_RCVD_LACKS_RDNS': 1, '__FPR_HEADER_250910_592020': 1, '__CT_TEXT_PLAIN': 1, '__FPR_HEADER_357218_696552': 1, '__VERY""" \
"""_SANE_MSGID': 1, '__FPR_HEADER_353482_694137': 1, '__FPR_HEADER_228918_555162': 1, 'ZBL_THREAD_INDEX_GOOD': 1, '__HAS""" \
"""_X_ORIGINALARRIVALTIME': 1, '__E2_KB_SOME_SUBJECT': 1, '__HAS_X_MAILER': 1, '__START_HTTP': 1, 'ZBL_SUBJ_SHORT_RANDOM""" \
"""_WORD': 1, '__HAS_MESSAGE_ID': 1, '__URI_NAME_TOPLEVEL_NON_US': 1, 'GTUBE': 1, '__FPR_HEADER_262542_618996': 1, '__FP""" \
"""R_HEADER_369344_703336': 1, 'IP_DQ_MSGID_0000_HEX4': 1, '__HAS_TRUSTED': 1, '__FPR_HEADER_360404_698393': 1, '__HAS_S""" \
"""UBJECT': 1, 'ZBL_OUTLOOK_EUDORA': 1, 'ZBL_XMAILER_OUTLOOK': 1, '__IMG_TXTR_13_14': 1, '__SANE_MSGID': 1, '___PL_RCVD_""" \
"""MSNORLIVEORMICROSOFT': 1, '__SUBJECT_NONE_OR_ONE': 1, '__FROM_HAS_ANGLE_BR': 1, '__CM_OUTLOOK_11_0_6353_XMAILER': 1, """ \
"""'__SUBJ_SHORT_RANDOM_WORD': 1, '__TO_HAS_ANGLE_BR': 1, '__TOCC_EXISTS': 1, '__FPR_HEADER_352725_693662': 1, '__HAS_CT""" \
"""_CHARSET': 1, '__FROM_REPEAT_OKAY4': 1, '__RL_CTE_7BIT': 1, '__MSGID_OK_HOST': 1, '__FPR_HEADER_272471_643634': 1, '_""" \
"""_THREAD_INDEX_GOOD': 1, '__MID_INTL_TLD': 1, '__HAS_MIMEOLE': 1, '__FPR_HEADER_356464_696001': 1, '__FPR_HEADER_32272""" \
"""9_679758': 1, '__FPR_HEADER_287303_661141': 1, '__FPR_HEADER_345997_689891': 1, '__FPR_HEADER_367777_702514': 1, '__I""" \
"""RONPORTSYSTEMS_MSGID': 1, '__FPR_HEADER_360190_698240': 1, '__OUTLOOK_EUDORA': 1, 'ZBL_HAS_THREAD_INDEX': 1, '__ZQ_UR""" \
"""I_HTTP': 1, '__FPR_HEADER_331091_683269': 1, '__FPR_HEADER_271199_640554': 1, '__HW_H_TO_NO_REAL_NAME': 1, '__RCVD_WE""" \
"""BMAIL': 1, '__FPR_HEADER_374137_705598': 1, '__HAS_MSGID': 1, '__HELO_RCVD_AZ': 1, '__XMAILER_OUTLOOK': 1, '__IP_DF_M""" \
"""ISC_OB_TO': 1, '__FPR_HEADER_332727_683961': 1, '__CT_US_ASCII': 1, '__FPR_HEADER_342974_688453': 1, 'ZBL_HAS_OUTLOOK""" \
"""_IN_MAILER': 1, '__THREAD_INDEX_SHORT': 1, '__HAS_RCVD': 1, '__ANY_MICROSOFT': 1, '__FPR_HEADER_371214_704149': 1, '_""" \
"""_CT': 1, '__ES_BODY_HTTP_COLON_SLASH_SLASH': 1, '__PRODUCED_BY_MS_OLE': 1, 'ZBL_PRODUCED_BY_MS_OLE': 1, 'ZBL_THREAD_I""" \
"""NDEX_SHORT': 1, 'ZBL_TO_HAS_ANGLE_BR': 1, '__MISSING_REPLY': 1, '__HAS_DATE': 1, '__CM_MSGID_REPEATS': 1, '__FPR_HEAD""" \
"""ER_373200_705158': 1, '__TO_ADDRESS_BRACKETED_NO_NAME': 1, '__FPR_HEADER_374446_705764': 1, '__FPR_BODY_348060_690936""" \
"""': 1}}, 'SBNP_AV': {'IP': {'0.0.0.0': {}}}}
"""

class TestSpamdClient(unittest2.TestCase):

    def setUp(self):

        self.mc = MockControl()
        self.mock_socket = self.mc.mock_class(_socket.socket, display_name='sock')
        mock_ctor_socket = self.mc.mock_constructor(_socket, 'socket')
        self.mc.mock_method(socket, 'socket')(socket.AF_INET, socket.SOCK_STREAM).returns(self.mock_socket)

    def tearDown(self):
        self.mc.tear_down()

    def test_ping(self):

        # Setup data.
        data = ['PING SPAMC/%s\r\n' % (PROTOCOL_VERSION,), 'Content-length: 0\r\n\r\n', '']

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns('SPAMD/1.1 0 PONG\r\n')
        self.mock_socket.recv(4096).returns('')

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))

        self.assertEqual(True, spamc.cmd_ping())

        self.mc.verify()

    def test_check(self):

        # Setup data.
        msg = gtube
        resp = gtube_check_resp
        spamd_result = gtube_check_result
        data = ['CHECK SPAMC/%s\r\n' % (PROTOCOL_VERSION,), ("Content-length: %d\r\n\r\n" % (len(msg),)), msg]

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns(resp)
        self.mock_socket.recv(4096).returns('')

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))
        result = spamc.cmd_check(msg)
        result_str = str(result)

        self.assertEqual(spamd_result, result_str)

        self.mc.verify()

    def test_process(self):

        # Setup data.
        msg = gtube
        resp = gtube_process_resp
        spamd_result = gtube_process_result
        data = ['PROCESS SPAMC/%s\r\n' % (PROTOCOL_VERSION,), ("Content-length: %d\r\n\r\n" % (len(msg),)), msg]

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns(resp)
        self.mock_socket.recv(4096).returns('')

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))
        result = spamc.cmd_process(msg)
        result_str = str(result)

        self.assertEqual(spamd_result, result_str)

        self.mc.verify()

    def test_check_with_rpc_input(self):

        # Setup data.
        msg = gtube
        rpc_input = {'config': {'vof_check': '0',
                                'spam_check': '1',
                                'spam_positive': 75,
                                'did_incoming_relay': 0}
                    }
        resp = rpc_check_resp
        spamd_result = rpc_check_result
        data = ['CHECK SPAMC/%s\r\nX-IronPort-MGA: %s\r\n' % (PROTOCOL_VERSION, bencode(rpc_input),),
                ("Content-length: %d\r\n\r\n" % (len(msg),)), msg]

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns(resp)
        self.mock_socket.recv(4096).returns('')

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))
        result = spamc.cmd_check(msg, case_dict=rpc_input)
        result_str = str(result)

        self.assertEqual(spamd_result, result_str)

        self.mc.verify()

    def test_error_response_from_server(self):

        # Setup data.
        msg = gtube
        # Response contains non-zero code, indicating error.
        resp = 'SPAMD/1.1 65 EX_DATAERR\r\n\r\n'

        data = ['CHECK SPAMC/%s\r\n' % (PROTOCOL_VERSION,), ("Content-length: %d\r\n\r\n" % (len(msg),)), msg]

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns(resp)

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))
        try:
            result = spamc.cmd_check(msg)
        except SpamdClientProtocolError:
            pass
        except Exception, e:
            self.fail('Unexpected exception thrown: %s' % (e,))
        else:
            self.fail('SpamdClientProtocolError not thrown')

        self.mc.verify()

    def test_malformed_CASE_response(self):

        # Setup data.
        msg = gtube
        # Response contains invalid bencode data.
        resp = 'SPAMD/1.1 0 EX_OK\r\nSpam: True ; 998.6 / 5.0\r\nX-IronPort-MGA: 35208734823ljdahflajhdf\r\nX-IronPort-IPAS-Score: 100\r\n\r\n'

        data = ['CHECK SPAMC/%s\r\n' % (PROTOCOL_VERSION,), ("Content-length: %d\r\n\r\n" % (len(msg),)), msg]

        # Setup mock calls.
        self.mock_socket.settimeout(5)
        self.mock_socket.setblocking(1)
        self.mock_socket.connect(('127.0.0.1', 783))
        for line in data:
            self.mock_socket.send(line)
        self.mock_socket.shutdown(socket.SHUT_WR)
        self.mock_socket.recv(4096).returns(resp)

        # Run tests.
        self.mc.replay()

        spamc = SpamdClient(('127.0.0.1', 783))
        try:
            result = spamc.cmd_check(msg)
            self.fail('SpamdClientMalformedRPC not thrown')
        except SpamdClientMalformedRPC:
            pass
        except Exception, e:
            self.fail('Unexpected exception thrown: %s' % (e,))

        self.mc.verify()


if __name__ == '__main__':
    unittest2.main()
